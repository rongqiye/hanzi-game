<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>找不同模式 - 汉字大作战</title>
    <!-- 添加音效资源 -->
    <audio id="correctSound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" preload="auto"></audio>
    <audio id="levelUpSound" src="https://assets.mixkit.co/active_storage/sfx/1997/1997-preview.mp3" preload="auto"></audio>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .header-bottom {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .score {
            font-size: 1.2em;
            color: #333;
        }
        
        .level {
            font-size: 1.2em;
            color: #4834d4;
        }
        
        .difficulty {
            font-size: 1.2em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 10px;
            color: white;
        }
        
        .difficulty.entry {
            background-color: #28a745;
        }
        
        .difficulty.beginner {
            background-color: #17a2b8;
        }
        
        .difficulty.intermediate {
            background-color: #ffc107;
            color: #333;
        }
        
        .difficulty.advanced {
            background-color: #dc3545;
        }
        
        .high-score {
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .cell {
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .cell:active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 8px;
            transition-delay: 0.05s;
        }
        
        .cell:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }
        
        .cell.correct {
            background: #d4edda;
            border-color: #c3e6cb;
            animation: pulse 0.5s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .cell.wrong {
            background: #f8d7da;
            border-color: #f5c6cb;
            animation: shake 0.5s;
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .restart-button {
            background: #4834d4;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            position: relative;
            touch-action: manipulation;
        }
        
        .restart-button::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
        }
        
        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .character {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .pinyin {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .meaning {
            font-size: 0.9em;
            color: #888;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }


        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* 移动设备优化 */
        @media (max-width: 500px) {
            .game-container {
                padding: 15px;
                width: 95%;
                max-width: none;
            }
            
            .cell {
                font-size: 1.5em;
            }
            
            .grid {
                gap: 3px;
            }
            
            .character {
                font-size: 2em;
            }
            
            .header-top, .header-bottom {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        /* 横屏模式优化 */
        @media (orientation: landscape) {
            .game-container {
                max-width: 90vh;
                margin: 10px auto;
            }
            
            .grid {
                grid-template-columns: repeat(10, 1fr);
                grid-template-rows: repeat(6, 1fr);
            }
            
            .character-info {
                grid-template-columns: 1fr;
            }
        }
        
        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(72, 52, 212, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 1.5em;
            z-index: 1000;
            animation: fadeInOut 2s;
            will-change: transform, opacity;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="header-top">
                <div class="timer" id="timer">30秒</div>
                <div class="score">分数: <span id="score">0</span></div>
            </div>
            <div class="header-bottom">
                <div class="level" id="level">关卡: 1/1</div>
                <div class="difficulty entry" id="difficulty">入门</div>
            </div>
            <div class="high-score">最高分: <span id="highScore">0</span></div>
        </div>
        
        <div class="grid" id="grid"></div>
        
        <div class="character-info" id="characterInfo" style="display: none;">
            <div class="info-box">
                <div class="character" id="char1"></div>
                <div class="pinyin" id="pinyin1"></div>
                <div class="meaning" id="meaning1"></div>
            </div>
            <div class="info-box">
                <div class="character" id="char2"></div>
                <div class="pinyin" id="pinyin2"></div>
                <div class="meaning" id="meaning2"></div>
            </div>
        </div>
        
        <button class="back-button" onclick="goBack()">返回主页</button>
    </div>

    <script>
        // 加载字符数据
        let characterData = [];
        try {
            const savedData = localStorage.getItem('characterData');
            if (!savedData) throw new Error('未找到游戏数据');
            
            characterData = JSON.parse(savedData);
            if (!Array.isArray(characterData) || characterData.length === 0) {
                throw new Error('游戏数据无效');
            }
            
            // 简单验证第一对数据
            const firstPair = characterData[0];
            if (!firstPair || !firstPair.char1 || !firstPair.char2) {
                throw new Error('游戏数据格式错误');
            }
        } catch (e) {
            alert(`游戏数据加载失败: ${e.message}
请返回主页重新加载数据`);
            window.location.href = 'index.html';
            throw e; // 使用throw代替return
        }

        let currentPair = null;
        let differentPosition = null;
        let timer = 30;
        let score = 0;
        let timerInterval = null;
        let gameActive = true;
        let currentLevel = 0;
        let highScore = parseInt(localStorage.getItem('findDifferenceHighScore') || '0');
        
        // 音效控制
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // 默认开启音效
        
        // 显示最高分
        document.getElementById('highScore').textContent = highScore;
        
        // 难度级别
        const difficultyLevels = [
            { name: "入门", class: "entry", range: [0, 9] },
            { name: "初级", class: "beginner", range: [10, 19] },
            { name: "中级", class: "intermediate", range: [20, 29] },
            { name: "高级", class: "advanced", range: [30, 39] }
        ];

        function initializeGame() {
            if (characterData.length === 0) {
                alert('游戏数据加载失败，请返回主页重试');
                return;
            }
            
            // 按顺序选择汉字对
            if (currentLevel >= characterData.length) {
                // 所有关卡完成，重置关卡
                currentLevel = 0;
                alert('恭喜！你已经完成了所有关卡！分数将重置。');
                score = 0;
                document.getElementById('score').textContent = score;
            }
            
            currentPair = characterData[currentLevel];
            differentPosition = Math.floor(Math.random() * 64);
            
            // 显示当前关卡信息
            document.getElementById('level').textContent = `关卡: ${currentLevel + 1}/${characterData.length}`;
            
            // 更新难度级别显示
            updateDifficultyDisplay();
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            // 调试信息
            console.log(`当前汉字对: ${currentPair.char1} vs ${currentPair.char2}`);
            console.log(`不同位置: ${differentPosition}, 将显示: ${currentPair.char1}`);
            
            for (let i = 0; i < 64; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const char = i === differentPosition ? currentPair.char1 : currentPair.char2;
                cell.textContent = char;
                cell.setAttribute('data-char', char); // 添加data属性便于检查
                cell.onclick = () => handleCellClick(i);
                grid.appendChild(cell);
                
                // 调试信息
                if (i === differentPosition) {
                    console.log(`位置 ${i} 设置为: ${char}`);
                }
            }
            
            // 确保字体支持
            const style = document.createElement('style');
            style.textContent = `
                .cell {
                    font-family: "Microsoft YaHei", "SimHei", sans-serif !important;
                    font-size: 2em !important;
                }
            `;
            document.head.appendChild(style);
            
            startTimer();
        }

        function startTimer() {
            timer = 30;
            const timerElement = document.getElementById('timer');
            timerElement.textContent = `${timer}秒`;
            
            timerInterval = setInterval(() => {
                timer--;
                timerElement.textContent = `${timer}秒`;
                
                if (timer <= 0) {
                    endGame(false);
                }
            }, 1000);
        }

        function handleCellClick(position) {
            if (!gameActive) return;
            
            const cells = document.querySelectorAll('.cell');
            
            if (position === differentPosition) {
                // 正确答案
                cells[position].classList.add('correct');
                
                // 播放正确音效
                if (soundEnabled) {
                    document.getElementById('correctSound').play();
                }
                
                // 增加分数
                score += timer;
                document.getElementById('score').textContent = score;
                
                // 更新最高分
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('findDifferenceHighScore', highScore);
                    document.getElementById('highScore').textContent = highScore;
                }
                
                endGame(true);
            } else {
                // 错误答案 - 游戏结束
                cells[position].classList.add('wrong');
                
                // 播放错误音效
                if (soundEnabled) {
                    document.getElementById('wrongSound').play();
                }
                
                endGame(false);
            }
        }
        
        // 更新难度级别显示
        function updateDifficultyDisplay() {
            const difficultyElement = document.getElementById('difficulty');
            
            // 移除所有难度类
            difficultyElement.classList.remove('entry', 'beginner', 'intermediate', 'advanced');
            
            // 确定当前难度级别
            let currentDifficulty = difficultyLevels[0]; // 默认为入门
            
            for (const level of difficultyLevels) {
                if (currentLevel >= level.range[0] && currentLevel <= level.range[1]) {
                    currentDifficulty = level;
                    break;
                }
            }
            
            // 应用当前难度
            difficultyElement.textContent = currentDifficulty.name;
            difficultyElement.classList.add(currentDifficulty.class);
        }

        function endGame(isWin) {
            gameActive = false;
            clearInterval(timerInterval);
            
            const cells = document.querySelectorAll('.cell');
            if (!isWin) {
                cells[differentPosition].classList.add('correct');
                
                // 创建游戏结束弹窗
                const gameOverModal = document.createElement('div');
                gameOverModal.className = 'game-over-modal';
                gameOverModal.innerHTML = `
                    <div class="modal-content">
                        <h2>游戏结束</h2>
                        <p>总得分: ${score}</p>
                        <button class="restart-button" onclick="restartFromBeginning()">重新开始</button>
                    </div>
                `;
                document.body.appendChild(gameOverModal);
            }
            
            // 显示汉字信息
            document.getElementById('characterInfo').style.display = 'grid';
            document.getElementById('char1').textContent = currentPair.char1;
            document.getElementById('pinyin1').textContent = currentPair.pinyin1;
            document.getElementById('meaning1').textContent = currentPair.meaning1;
            document.getElementById('char2').textContent = currentPair.char2;
            document.getElementById('pinyin2').textContent = currentPair.pinyin2;
            document.getElementById('meaning2').textContent = currentPair.meaning2;
            
            if (isWin) {
                // 检查是否进入新的难度级别
                const oldLevel = currentLevel;
                currentLevel++;
                
                // 检查是否升级难度
                const oldDifficultyIndex = Math.floor(oldLevel / 10);
                const newDifficultyIndex = Math.floor(currentLevel / 10);
                
                if (newDifficultyIndex > oldDifficultyIndex && newDifficultyIndex < difficultyLevels.length) {
                    // 显示升级通知
                    const notification = document.createElement('div');
                    notification.className = 'level-up-notification';
                    notification.textContent = `恭喜！难度提升至 ${difficultyLevels[newDifficultyIndex].name}`;
                    document.body.appendChild(notification);
                    
                    // 播放升级音效
                    if (soundEnabled) {
                        document.getElementById('levelUpSound').play();
                    }
                    
                    // 2秒后移除通知
                    setTimeout(() => {
                        notification.remove();
                    }, 2000);
                }
                
                setTimeout(() => {
                    resetGame();
                }, 1000);
            }
        }

        function restartFromBeginning() {
            // 移除游戏结束弹窗
            const modal = document.querySelector('.game-over-modal');
            if (modal) {
                modal.remove();
            }
            
            // 重置关卡和分数
            currentLevel = 0;
            score = 0;
            localStorage.setItem('findDifferenceLevel', '0');
            document.getElementById('score').textContent = score;
            
            // 重新开始游戏
            resetGame();
        }

        function resetGame() {
            gameActive = true;
            initializeGame();
        }

        function goBack() {
            window.location.href = 'index.html';
        }


        
        // 切换音效
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            return soundEnabled;
        }
        
        // 添加键盘快捷键支持
        document.addEventListener('keydown', (event) => {
            if (!gameActive) return;
            
            // 空格键暂停/继续游戏
            if (event.code === 'Space') {
                event.preventDefault();
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                } else {
                    startTimer();
                }
            }
            
            // M键切换音效
            if (event.code === 'KeyM') {
                const isSoundOn = toggleSound();
                alert(isSoundOn ? '音效已开启' : '音效已关闭');
            }
        });

        // 初始化游戏
        initializeGame();
    </script>
</body>
</html>